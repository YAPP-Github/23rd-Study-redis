- Redis는 Redis Cluster 라는 배포 토폴로지를 통해 수평적으로 확장

# Redis Cluster 101
- 데이터 세트를 `여러 노드에 자동으로 분할`
- 노드의 하위 집합에 오류가 발생하거나 클러스터의 나머지 부분과 통신할 수 없는 경우에도 작업 지속

- ## Redis 클러스터 TCP 포트
    - 모든 Redis 클러스터 노드에는 `두 개의 개방형 TCP 연결이 필요`
    - Redis TCP 포트, 클러스터 버스 포트
    - `클러스터 버스`는 바이너리 프로토콜을 사용하는 노드 간 통신 채널, 대역폭과 처리 시간이 적기 때문에 `노드 간 정보 교환에 더 적합`
    - `클라이언트`는 클러스터 버스 포트와 통신을 시도해서는 안 되며 대신 `Redis 명령 포트를 사용해야 함`

- ## Redis 클러스터 및 Docker
    - 현재 Redis 클러스터는 NAT 환경이나 IP 주소나 TCP 포트가 재매핑되는 환경을 지원하지 않음
    - Docker는 포트 매핑이라는 기술을 사용. Docker 컨테이너 내부에서 실행되는 프로그램은 프로그램이 사용하고 있다고 생각하는 포트와 다른 포트로 노출될 수 있음. 이는 동일한 서버에서 동일한 포트를 사용하는 여러 컨테이너를 동시에 실행하는 데 유용
    - Docker를 Redis 클러스터와 호환되게 하려면, Docker의 호스트 네트워킹 모드를 사용해야 함

- ## Redis 클러스터 데이터 샤딩
    - Redis 클러스터는 일관된 해싱을 사용하지 않지만 모든 키가 개념적으로 해시 슬롯 이라고 부르는 것의 일부인 다른 형태의 샤딩을 사용
    - Redis 클러스터에는 16384개의 해시 슬롯 존재
    - 키 모듈로 16384의 CRC16을 사용
    - 키의 {} 대괄호 사이에 하위 문자열이 있는 경우 문자열 내부에 있는 내용만 해시
    ```
    user:{123}:profile 과 user:{123}:account 는 동일한 해시 태그를 공유하므로 동일한 해시 슬롯에 있음이 보장
    ```

- ## Redis 클러스터 마스터-복제본 모델
    - 마스터 노드의 하위 집합에 장애가 발생하거나 대부분의 노드와 통신할 수 없는 경우에도 계속 사용할 수 있도록 Redis 클러스터는 모든 해시 슬롯에 1개(마스터 자체)부터 N개의 복제본(N-1)이 있는 마스터-복제본 모델을 사용

- ## Redis 클러스터 일관성 보장
    - Redis 클러스터는 `강력한 일관성을 보장하지 않음`
    - 기본적으로 `비동기 복제 사용`
    ```
    클라이언트가 마스터 B에 씀
    마스터 B는 고객에게 OK라고 응답
    마스터 B는 복제본 B1, B2 및 B3에 쓰기 전파

    B는 클라이언트에 응답하기 전에 B1, B2, B3의 승인을 기다리지 않음
    ```
    - Redis 클러스터는 꼭 필요한 경우 명령을 통해 구현되는 동기식 쓰기를 지원하지만, 동기식이어도 일관성 보장 안됨

# Redis Cluster configuration parameters
- Cluster-enabled`<yes/no>`
    - Redis 클러스터 활성화
- Cluster-config-file`<filename>`
    - Redis 클러스터 노드가 변경될 때마다 자동으로 클러스터 구성(기본적으로 상태)을 유지하는 파일
- Cluster-node-timeout`<milliseconds>`
    - 지정된 시간 이상 마스터 노드에 연결할 수 없으면 해당 복제본에 의해 장애 조치
- Cluster-slave-validity-factor`<factor>`
    - 0 으로 설정되면 복제본은 항상 자신이 유효한 것으로 간주하므로 마스터와 복제본 사이의 링크가 연결 해제된 시간에 관계없이 항상 마스터 장애 조치를 시도
    - 노드 시간 초과가 5초로 설정되고 유효성 계수가 10으로 설정된 경우 50초 이상 마스터에서 연결이 끊어진 복제본은 마스터 장애 조치를 시도하지 않음
- Cluster-migration-barrier`<count>`
    - 마스터가 다른 복제본이 더 이상 어떤 복제본에도 포함되지 않는 마스터로 이동할 수 있도록 연결을 유지할 최소 복제본 수
- Cluster-require-full-coverage`<yes/no>`
    - `yes` 로 설정되어 있으면, 키 공간의 일부가 어떤 노드에도 포함되지 않는 경우 클러스터는 쓰기 작업을 수락하지 않음
    - `no` 로 설정된 경우, 클러스터는 키의 일부분에 대한 요청만 처리할 수 있더라도 여전히 쿼리를 처리
- Cluster-allow-reads-when-down`<yes/no>`
    - `yes` 로 설정하면 실패 상태 동안 노드에서 읽기를 허용
    - `no` 로 설정되면 Redis 클러스터의 노드는 클러스터가 실패로 표시되거나 노드가 도달할 수 없을 때 모든 트래픽 제공을 중지