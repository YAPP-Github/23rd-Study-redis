# Redis Replication
- master - replica
- 복제본은 링크가 끊어질 때 마다 자동으로 마스터에 다시 연결, 마스터에 무슨 일이 일어나든 관계없이 정확한 복사본이 되려고 시도
- 3가지 주요 메커니즘
    1. 마스터와 복제본 인스턴스가 잘 연결되어 있으면 마스터 측에서 발생하는 데이터 세트에 미치는 영향을 복제하기 위해 복제본에 명령 스트림을 보내 복제본을 업데이트된 상태로 유지
    2. 마스터와 복제본 사이의 링크가 끊어지거나, 네트워크 문제로 인해 또는 마스터나 복제본에서 시간 초과가 감지되면, partial resynchronization 시도
    3. partial resynchronization 가 불가능한 경우, full resynchronization 요청
        - 마스터가 모든 데이터의 스냅샷을 생성하여 복제본으로 보낸 다음 데이터 세트가 변경됨에 따라 명령 스트림을 계속 보내야 하는 더 복잡한 프로세스 
- 기본적으로 비동기로 동작하지만, 필요한 경우 동기로 복제 가능

# Diskless replication
- 일반적으로 전체 재동기화를 수행하려면 디스크에 RDB 파일을 생성한 다음 디스크에서 동일한 RDB를 다시 로드하여 복제본에 데이터를 공급
- 느린 디스크의 경우 이는 마스터에게 매우 스트레스가 되는 작업
- Redis 2.8.18 부터 디스크를 중간 저장소로 사용하지 않고 유선을 통해 RDB를 복제본으로 직접 전송

# Read-only replica
- 쓰기 가능한 복제본을 사용하면 마스터와 복제본 사이에 불일치가 발생할 수 있으므로 쓰기 가능한 복제본을 사용하지 않는 것이 좋다


# Allow writes only with N attached replicas
- Redis 2.8부터 현재 N개 이상의 복제본이 마스터에 연결된 경우에만 쓰기 쿼리를 허용하도록 Redis 마스터를 구성할 수 있음
- 작동 방식
    - Redis 복제본은 매초마다 마스터에 ping을 보내 처리된 복제 스트림의 양 확인
    - Redis 마스터는 모든 복제본에서 마지막으로 ping을 받은 시간 기억
    - 사용자는 최대 시간(초)보다 크지 않은 지연이 있는 최소 복제본 수를 구성
- N개 이상의 복제본이 있고 지연 시간이 M초 미만인 경우 쓰기가 허용
- 조건이 충족되지 않으면 마스터는 대신 오류로 응답하고 쓰기가 허용되지 않음

# How Redis replication deals with expires on keys
- 복제본은 키가 만료되지 않고 대신 마스터가 키가 만료될 때까지 기다림. 마스터가 키를 만료할 때 DEL모든 복제본에 전송
- 그러나 마스터 구동 만료로 인해 마스터가 제때에 명령을 제공할 수 없었기 때문에 복제본에는 논리적으로 이미 만료된 키가 여전히 메모리에 남아 있을 수 있음
- 이를 처리하기 위해 복제본은 논리 시계를 사용

# Partial sync after restarts and failovers
- Redis 4.0부터 장애 조치 후 인스턴스가 마스터로 승격되면 여전히 이전 마스터의 복제본과 부분적인 재동기화를 수행할 수 있음
- 이를 위해 복제본은 이전 마스터의 이전 복제 ID와 오프셋을 기억하므로 이전 복제 ID를 요청하더라도 연결 복제본에 백로그의 일부를 제공할 수 있음
- 복제본은 전원이 꺼졌다가 다시 시작될 때 RDB 에 재동기화하는 데 필요한 정보를 파일에 저장할 수 있음

# Maxmemory on replicas
- 복제본은 기본적으로 maxmemory 값을 무시
- 마스터와 복제본이 일관성을 유지하도록 보장
